name: Ubuntu Desktop with noVNC and Tunnel # This should be 'name', not 'Name' and at the top

on:
  workflow_dispatch:

jobs:
  run-desktop:
    runs-on: ubuntu-latest

    steps:
    - name: Install dependencies # This 'name' is for the step
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver git curl wget openssh-client
        sudo apt install -y python3 python3-pip
        pip3 install websockify

    - name: Setup VNC server and noVNC
      run: |
        mkdir -p ~/.vnc
        echo "sidBRA+123" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

        echo '#!/bin/bash
        xrdb $HOME/.Xresources
        startxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup

        vncserver :1 -geometry 1280x720 -depth 24
        vncserver -kill :1
        vncserver :1 -geometry 1280x720 -depth 24

        git clone https://github.com/novnc/noVNC.git ~/noVNC
        git clone https://github.com/novnc/websockify.git ~/noVNC/utils/websockify

    - name: Run noVNC server
      run: |
        nohup ~/noVNC/utils/launch.sh --vnc localhost:5901 --listen 6080 &

    - name: Create tunnel with serveo.net
      id: serveo_tunnel
      run: |
        # Start the SSH tunnel in the background and capture its output
        nohup ssh -o StrictHostKeyChecking=no -o ExitOnForwardFailure=yes -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -R 80:localhost:6080 serveo.net 2>&1 &
        sleep 15 # Give serveo.net some time to establish the tunnel and print the URL

        # Attempt to extract the public URL
        TUNNEL_URL=$(grep -oP '(?<=Forwarding HTTP traffic from )\S+' nohup.out | head -1)

        if [ -z "$TUNNEL_URL" ]; then
          echo "Warning: Could not automatically extract the tunnel URL. Please check the logs for the serveo.net output."
          echo "::set-output name=tunnel_url::Not Found"
        else
          echo "ðŸš€ Tunnel should be up! Public URL: $TUNNEL_URL"
          echo "::set-output name=tunnel_url::$TUNNEL_URL"
        fi
        ps aux | grep ssh

    - name: Show connection info
      run: |
        echo "-------------------------------------------"
        echo "ðŸ”‘ VNC password: sidBRA+123"
        echo "ðŸŒ Open this URL in your browser: ${{ steps.serveo_tunnel.outputs.tunnel_url }}"
        echo "-------------------------------------------"
        
